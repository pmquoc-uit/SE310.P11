import{b as Z}from"./chunk-DZD3CKYG.js";import{a as ee}from"./chunk-TC32T2HF.js";import{B as te,F as re,G as ie,H as ne,I as oe,J as ae,Q as se,T as le,X as ce,Z as de}from"./chunk-MR5DOF4S.js";import{b as P,ja as $,k as Y,n as w}from"./chunk-3SLA3PJL.js";import{Aa as I,Eb as B,Fc as k,Jb as a,Kb as s,Oc as K,Pb as F,Rc as J,Sb as T,Ub as W,Uc as Q,cc as l,da as q,eb as p,ec as h,f as d,ga as C,gc as G,hc as z,ic as H,kc as X,ma as u,oc as S,pc as y,qa as R,sb as O,xb as M,y as m,z as E,za as x,zb as _}from"./chunk-EF2V77MD.js";var me="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var ue=(i=21)=>{let n="",e=crypto.getRandomValues(new Uint8Array(i));for(;i--;)n+=me[e[i]&63];return n};var U=class{constructor(){this.id=ue(),this.items=[]}};var j=(()=>{class i{constructor(){this.baseUrl=w.apiUrl,this.http=u(P),this.cart=O(null),this.itemCount=k(()=>this.cart()?.items.reduce((e,t)=>e+t.quantity,0)),this.selectedDelivery=O(null),this.totals=k(()=>{let e=this.cart(),t=this.selectedDelivery();if(!e)return null;let r=e.items.reduce((f,v)=>f+v.price*v.quantity,0),o=0;e.coupon&&(e.coupon.amountOff?o=e.coupon.amountOff:e.coupon.percentOff&&(o=r*(e.coupon.percentOff/100)));let c=t?t.price:0;return{subtotal:r,shipping:c,discount:o,total:r+c-o}})}getCart(e){return this.http.get(this.baseUrl+"cart?id="+e).pipe(E(t=>(this.cart.set(t),t)))}setCart(e){return this.http.post(this.baseUrl+"cart",e).pipe(q(t=>{this.cart.set(t)}))}applyDiscount(e){return this.http.get(this.baseUrl+"coupons/"+e)}addItemToCart(e,t=1){return d(this,null,function*(){let r=this.cart()??this.createCart();this.isProduct(e)&&(e=this.mapProductToCartItem(e)),r.items=this.addOrUpdateItem(r.items,e,t),yield m(this.setCart(r))})}removeItemFromCart(e,t=1){return d(this,null,function*(){let r=this.cart();if(!r)return;let o=r.items.findIndex(c=>c.productId===e);o!==-1&&(r.items[o].quantity>t?r.items[o].quantity-=t:r.items.splice(o,1),r.items.length===0?this.deleteCart():yield m(this.setCart(r)))})}deleteCart(){this.http.delete(this.baseUrl+"cart?id="+this.cart()?.id).subscribe({next:()=>{localStorage.removeItem("cart_id"),this.cart.set(null)}})}addOrUpdateItem(e,t,r){let o=e.findIndex(c=>c.productId===t.productId);return o===-1?(t.quantity=r,e.push(t)):e[o].quantity+=r,e}mapProductToCartItem(e){return{productId:e.id,productName:e.name,price:e.price,quantity:0,pictureUrl:e.pictureUrl,brand:e.brand,type:e.type}}isProduct(e){return e.id!==void 0}createCart(){let e=new U;return localStorage.setItem("cart_id",e.id),e}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var ve="https://js.stripe.com/v3",ge=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,fe="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",Ee=function(){for(var n=document.querySelectorAll('script[src^="'.concat(ve,'"]')),e=0;e<n.length;e++){var t=n[e];if(ge.test(t.src))return t}return null},he=function(n){var e=n&&!n.advancedFraudSignals?"?advancedFraudSignals=false":"",t=document.createElement("script");t.src="".concat(ve).concat(e);var r=document.head||document.body;if(!r)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return r.appendChild(t),t},Ce=function(n,e){!n||!n._registerWrapper||n._registerWrapper({name:"stripe-js",version:"4.0.0",startTime:e})},b=null,V=null,L=null,xe=function(n){return function(){n(new Error("Failed to load Stripe.js"))}},Ie=function(n,e){return function(){window.Stripe?n(window.Stripe):e(new Error("Stripe.js not available"))}},_e=function(n){return b!==null?b:(b=new Promise(function(e,t){if(typeof window>"u"||typeof document>"u"){e(null);return}if(window.Stripe&&n&&console.warn(fe),window.Stripe){e(window.Stripe);return}try{var r=Ee();if(r&&n)console.warn(fe);else if(!r)r=he(n);else if(r&&L!==null&&V!==null){var o;r.removeEventListener("load",L),r.removeEventListener("error",V),(o=r.parentNode)===null||o===void 0||o.removeChild(r),r=he(n)}L=Ie(e,t),V=xe(t),r.addEventListener("load",L),r.addEventListener("error",V)}catch(c){t(c);return}}),b.catch(function(e){return b=null,Promise.reject(e)}))},Pe=function(n,e,t){if(n===null)return null;var r=n.apply(void 0,e);return Ce(r,t),r},g,Se=!1,ye=function(){return g||(g=_e(null).catch(function(n){return g=null,Promise.reject(n)}),g)};Promise.resolve().then(function(){return ye()}).catch(function(i){Se||console.warn(i)});var we=function(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];Se=!0;var r=Date.now();return ye().then(function(o){return Pe(o,e,r)})};var be=(()=>{class i{constructor(){this.baseUrl=w.apiUrl,this.cartService=u(j),this.accountService=u(Z),this.http=u(P),this.stripePromise=we(w.stripePublicKey)}getStripeInstance(){return this.stripePromise}initializeElements(){return d(this,null,function*(){if(!this.elements){let e=yield this.getStripeInstance();if(e){let t=yield m(this.createOrUpdatePaymentIntent());this.elements=e.elements({clientSecret:t.clientSecret,appearance:{labels:"floating"}})}else throw new Error("Stripe has not been loaded")}return this.elements})}createPaymentElement(){return d(this,null,function*(){if(!this.paymentElement){let e=yield this.initializeElements();if(e)this.paymentElement=e.create("payment");else throw new Error("Elements instance has not been initialized")}return this.paymentElement})}createAddressElement(){return d(this,null,function*(){if(!this.addressElement){let e=yield this.initializeElements();if(e){let t=this.accountService.currentUser(),r={};t&&(r.name=t.firstName+" "+t.lastName),t?.address&&(r.address={line1:t.address.line1,line2:t.address.line2,city:t.address.city,state:t.address.state,country:t.address.country,postal_code:t.address.postalCode});let o={mode:"shipping",defaultValues:r};this.addressElement=e.create("address",o)}else throw new Error("Elements instance has not been loaded")}return this.addressElement})}createConfirmationToken(){return d(this,null,function*(){let e=yield this.getStripeInstance(),t=yield this.initializeElements(),r=yield t.submit();if(r.error)throw new Error(r.error.message);if(e)return yield e.createConfirmationToken({elements:t});throw new Error("Stripe not available")})}confirmPayment(e){return d(this,null,function*(){let t=yield this.getStripeInstance(),o=yield(yield this.initializeElements()).submit();if(o.error)throw new Error(o.error.message);let c=this.cartService.cart()?.clientSecret;if(t&&c)return yield t.confirmPayment({clientSecret:c,confirmParams:{confirmation_token:e.id},redirect:"if_required"});throw new Error("Unable to load stripe")})}createOrUpdatePaymentIntent(){let e=this.cartService.cart(),t=!!e?.clientSecret;if(!e)throw new Error("Problem with cart");return this.http.post(this.baseUrl+"payments/"+e.id,{}).pipe(E(r=>d(this,null,function*(){return t||(yield m(this.cartService.setCart(r))),r})))}disposeElements(){this.elements=void 0,this.addressElement=void 0,this.paymentElement=void 0}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=C({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function Ue(i,n){i&1&&(a(0,"div",11)(1,"button",19),l(2,"Checkout"),s(),a(3,"button",20),l(4,"Continue Shopping"),s()())}function je(i,n){if(i&1){let e=F();a(0,"div",21)(1,"span",22),l(2),s(),a(3,"button",23),T("click",function(){x(e);let r=W();return I(r.removeCouponCode())}),a(4,"mat-icon",24),l(5,"delete"),s()()()}if(i&2){let e=n.ngIf;p(2),h("",e.name," applied")}}var ht=(()=>{class i{constructor(){this.cartService=u(j),this.stripeService=u(be),this.location=u(K)}applyCouponCode(){this.code&&this.cartService.applyDiscount(this.code).subscribe({next:e=>d(this,null,function*(){let t=this.cartService.cart();t&&(t.coupon=e,yield m(this.cartService.setCart(t)),this.code=void 0,this.location.path()==="/checkout"&&(yield m(this.stripeService.createOrUpdatePaymentIntent())))})})}removeCouponCode(){return d(this,null,function*(){let e=this.cartService.cart();e&&(e.coupon&&(e.coupon=void 0),yield m(this.cartService.setCart(e)),this.location.path()==="/checkout"&&(yield m(this.stripeService.createOrUpdatePaymentIntent())))})}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275cmp=R({type:i,selectors:[["app-order-summary"]],standalone:!0,features:[X],decls:43,vars:17,consts:[["form","ngForm"],[1,"mx-auto","max-w-4xl","flex-1","space-y-6","w-full"],[1,"space-y-4","rounded-lg","border","border-gray-200","p-4","bg-white","shadow-sm"],[1,"text-xl","font-semibold"],[1,"space-y-4"],[1,"space-y-2"],[1,"flex","items-center","justify-between","gap-4"],[1,"font-medium","text-gray-500"],[1,"font-medium","text-gray-900"],[1,"font-medium","text-green-500"],[1,"flex","items-center","justify-between","gap-4","border-t","border-gray-200","pt-2"],[1,"flex","flex-col","gap-2"],[1,"space-y-4","rounded-lg","border","border-gray-200","bg-white","shadow-sm"],[1,"space-y-2","flex","flex-col","p-2",3,"ngSubmit"],[1,"mb-2","block","text-sm","font-mediem"],["class","flex justify-between items-center",4,"ngIf"],["appearance","outline"],["name","code","type","text","matInput","",3,"ngModelChange","disabled","ngModel"],["type","submit","mat-flat-button","",3,"disabled"],["routerLink","/checkout","mat-flat-button",""],["routerLink","/shop","mat-button",""],[1,"flex","justify-between","items-center"],[1,"text-sm","font-semibold"],["mat-icon-button","",3,"click"],["color","warn"]],template:function(t,r){if(t&1){let o=F();a(0,"div",1)(1,"div",2)(2,"p",3),l(3,"Order summary"),s(),a(4,"div",4)(5,"div",5)(6,"dl",6)(7,"dt",7),l(8,"Subtotal"),s(),a(9,"dd",8),l(10),S(11,"currency"),s()(),a(12,"dl",6)(13,"dt",7),l(14,"Discount"),s(),a(15,"dd",9),l(16),S(17,"currency"),s()(),a(18,"dl",6)(19,"dt",7),l(20,"Delivery fee"),s(),a(21,"dd",8),l(22),S(23,"currency"),s()()(),a(24,"dl",10)(25,"dt",7),l(26,"Total"),s(),a(27,"dd",8),l(28),S(29,"currency"),s()()(),M(30,Ue,5,0,"div",11),s(),a(31,"div",12)(32,"form",13,0),T("ngSubmit",function(){return x(o),I(r.applyCouponCode())}),a(34,"label",14),l(35," Do you have a voucher code? "),s(),M(36,je,6,1,"div",15),a(37,"mat-form-field",16)(38,"mat-label"),l(39,"Voucher code"),s(),a(40,"input",17),H("ngModelChange",function(f){return x(o),z(r.code,f)||(r.code=f),I(f)}),s()(),a(41,"button",18),l(42," Apply code "),s()()()()}if(t&2){let o,c,f,v,A,D,N;p(10),h(" ",y(11,9,(o=r.cartService.totals())==null?null:o.subtotal)," "),p(6),h(" -",y(17,11,(c=r.cartService.totals())==null?null:c.discount)," "),p(6),h(" ",y(23,13,(f=r.cartService.totals())==null?null:f.shipping)," "),p(6),h(" ",y(29,15,(v=r.cartService.totals())==null?null:v.total)," "),p(2),B(r.location.path()!=="/checkout"?30:-1),p(6),_("ngIf",(A=r.cartService.cart())==null?null:A.coupon),p(4),_("disabled",!!((D=r.cartService.cart())!=null&&D.coupon)),G("ngModel",r.code),p(),_("disabled",!!((N=r.cartService.cart())!=null&&N.coupon))}},dependencies:[$,Y,ce,le,de,Q,se,ae,te,re,ie,oe,ne,J,ee]})}}return i})();export{j as a,be as b,ht as c};
